{% extends 'frc_scout/base.html' %}

{% load staticfiles %}

{% block title %}Scouting{% endblock %}

{% block main_content %}

    <!-- ERRORS -->
    <div class="container-fluid">
        <div class="alert alert-warning alert-dismissible" role="alert" id="alert" style="margin-top: 10px; display: none;">
            <button type="button" class="close" onclick="$('#alert').hide();" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <p><strong>Please correct the following errors:</strong></p>
            <span id="alert-text"></span>
        </div>
    </div>
	
	<!-- LOADING SCREEN -->
	<div class="container" id="loading">
        <h1>
            Loading...
        </h1>
	</div>

    <!-- PREMATCH -->
    <div class="container-fluid stage" style="display: none;" id="prematch">
        <div class="row">
            <div class="col-md-12">
                <h2>Pre-Match<span class="team-number"></span></h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <input id="team_number" class="form-control input-x-lg" placeholder="Team Number">
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-12">
                <div class="btn-group max-width" data-toggle="buttons">
                    <label class="btn btn-lg btn-danger alliance-toggle" style="width: 50%;" id="red_alliance">
                        <input type="radio">
                        Red Alliance
                    </label>
                    <label class="btn btn-lg btn-primary alliance-toggle" style="width: 50%;" id="blue_alliance">
                        <input type="radio">
                        Blue Alliance
                    </label>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-12">
                <input id="match_number" class="form-control input-x-lg" placeholder="Match Number">
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h3 style="color: #666666;">Location: {{ request.session.location_name }}</h3>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-12">
                <button class="btn btn-extra-high btn-primary btn-lg max-width" onclick="saveAndContinue('prematch', 'autonomous');">autonomous &nbsp;<span class="glyphicon glyphicon-arrow-right"></span></button>
            </div>
        </div>
    </div>

    <!-- AUTONOMOUS -->
    <div class="container-fluid stage" style="display: none;" id="autonomous">
        <div class="row">
            <div class="col-md-12">
                <h2>Autonomous<span class="team-number"></span></h2>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <h3>Totes</h3>
                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-stacked-yellow-tote" data-operation="add">Stacked Yellow</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-stacked-yellow-tote" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-stacked-yellow-tote-text" data-max="3">0</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-moved-yellow-tote" data-operation="add">Moved Yellow</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-moved-yellow-tote" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-moved-yellow-tote-text" data-max="3">0</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-acquired-grey-tote" data-operation="add">Acquired Grey</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-acquired-grey-tote" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-acquired-grey-tote-text">0</h4>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <h3>Bins</h3>
                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-acquired-step-bin" data-operation="add">Acquired Step</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-acquired-step-bin" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-acquired-step-bin-text" data-max="4">0</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-acquired-ground-bin" data-operation="add">Acquired Ground</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-acquired-ground-bin" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-acquired-ground-bin-text" data-max="3">0</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-8">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-success max-width btn-add-subtract" data-name="auto-moved-bin" data-operation="add">Moved</button>
                    </div>
                    <div class="col-xs-2">
                        <button class="btn btn-extra-high btn-lg btn-lg-text btn-warning btn-add-subtract" data-name="auto-moved-bin" data-operation="subtract">&mdash;</button>
                    </div>
                    <div class="col-xs-2 text-center">
                        <h4 class="button-state-text" id="auto-moved-bin-text">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-sm-6">
                <button style="margin-top: 5px; margin-bottom: 5px;" class="btn btn-extra-high btn-danger btn-lg max-width" onclick="saveAndContinue('autonomous', 'autonomous_fouls_and_other');">Fouls & Other</button>
            </div>
            <div class="col-sm-6">
                <button style="margin-top: 5px; margin-bottom: 5px;" class="btn btn-extra-high btn-primary btn-lg max-width" onclick="saveAndContinue('autonomous', 'teleoperated');">teleoperated  &nbsp;<span class="glyphicon glyphicon-arrow-right"></span></button>
            </div>
        </div>
    </div>

    <!-- AUTONOMOUS FOULS & OTHER -->
    <div class="container-fluid stage" id="autonomous_fouls_and_other" style="display: none;">
        <div class="row">
            <div class="col-md-12" style="margin-top: 2vh;">
                <button id="auto_fouls" onclick="saveAndContinue('autonomous_fouls_and_other', 'autonomous', this);" class="btn btn-lg btn-warning max-width" style="height: 30vh; margin-top: 1vh; margin-bottom: 1vh; font-size: 30px;">fouls</button>
            </div>
            <div class="col-md-12">
                <button id="auto_interference" onclick="saveAndContinue('autonomous_fouls_and_other', 'autonomous', this);" class="btn btn-lg btn-info max-width" style="height: 30vh; margin-top: 1vh; margin-bottom: 1vh; font-size: 30px;">interference</button>
            </div>
            <div class="col-md-12">
                <button id="auto_no_auto" onclick="saveAndContinue('autonomous_fouls_and_other', 'autonomous', this);" class="btn btn-lg btn-primary max-width" style="height: 30vh; margin-top: 1vh; font-size: 30px;">no auto</button>
            </div>
        </div>
    </div>

    <!-- TELEOPERATED -->
    <div class="container-fluid stage" id="teleoperated" style="display:none;">
        <h1>TELEOP<span class="team-number"></span></h1>
    </div>

{% endblock %}


{% block extra_js %}
    <script type="text/javascript">

        var backgroundColorRed = "rgb(255, 236, 236)";
        var backgroundColorBlue = "rgb(232, 237, 255)";

        $(".alliance-toggle").click(function() {
            var id = this.id;

            if(id === "blue_alliance") {
                $("body").css("background-color", backgroundColorBlue);
            }

            else if(id === "red_alliance") {
                $("body").css("background-color", backgroundColorRed);
            }

            localStorage.allianceColor = id;
        });

        $("#team_number").keyup(function() {
            $(".team-number").text(": " + $("#team_number").val());
        });

        $(function() {
            // always hide the loading thing once js is run
            $("#loading").hide();
            
            /* If there's no hash setup a new match */
            if(window.location.hash === "") {
                setupNewMatch();
                console.log("new match: " + localStorage.pageMatchID);
                window.location.hash = "prematch";
                $("#" + window.location.hash.substring(1)).show();
                /* otherwise grab the old one and reuse it */
            } else {
                $(".stage").hide();
                $("#" + window.location.hash.substring(1)).show();
            }

            $("#alert").hide();
        });

        function setupNewMatch() {
            /* Iterate through all matches currently in localStorage until we find an empty one */
            localStorage.allianceColor = undefined;
            for(var i = 0;; i++) {
                if (localStorage["match" + i.toString()] === undefined) {
                    /* Then set our current match to a new one, storing the new one in localStorage */
                    localStorage.pageMatchID = i;
                    localStorage["match" + localStorage.pageMatchID.toString()] = JSON.stringify({});
                    break;
                }
            }
        }

        /*
         This function handles stage changes and will be able to deal with page refreshes eventually
         */
        function saveAndContinue(fromStage, toStage, sender) {

            var storedVariables = $.parseJSON(localStorage["match" + localStorage.pageMatchID]);

            // assume no errors
            var errorMessage = [];

            // no variables for now
            var stageVariables = null;

            /**
             * FROM STAGES
             **/

            if(fromStage == "prematch") {
                var teamNumber = parseInt($("#team_number").val());
                var matchNumber = parseInt($("#match_number").val());

                if(isNaN(teamNumber)) {
                    errorMessage.push("Team number is required and must be a number.");
                }

                if(isNaN(matchNumber)) {
                    errorMessage.push("Match number is required and must be a number.");
                }

                if(!($("#red_alliance").hasClass('active') || $("#blue_alliance").hasClass('active'))) {
                    errorMessage.push("Alliance color is required.");
                }

                stageVariables = {
                    teamNumber: teamNumber,
                    matchNumber: matchNumber
                }
            }

            else if(fromStage == "autonomous") {
                // totes
                var autoStackedYellowTotes = parseInt($("#auto-stacked-yellow-tote-text").text());
                var autoMovedYellowTotes = parseInt($("#auto-moved-yellow-tote-text").text());
                var autoAcquiredGreyTotes = parseInt($("#auto-acquired-grey-tote-text").text());

                // bins
                var autoAcquiredStepBins = parseInt($("#auto-acquired-step-bin-text").text());
                var autoAcquiredGroundBins = parseInt($("#auto-acquired-ground-bin-text").text());
                var autoMovedBins = parseInt($("#auto-moved-bin-text").text());

                stageVariables = {
                    autoStackedYellowTotes: autoStackedYellowTotes,
                    autoMovedYellowTotes: autoMovedYellowTotes,
                    autoAcquiredGreyTotes: autoAcquiredGreyTotes,

                    autoAcquiredStepBins: autoAcquiredStepBins,
                    autoAcquiredGroundBins: autoAcquiredGroundBins,
                    autoMovedBins: autoMovedBins
                }

                $.each(stageVariables, function(index, variable) {
                    if(isNaN(variable)) {
                        errorMessage.push("One or more of your variables are not numbers, what are you doing?");
                        return false;
                    }
                })
            }

            else if(fromStage === "autonomous_fouls_and_other") {

                var id = sender.id;

                if(storedVariables['autonomous_fouls_and_other'] === undefined) {
                    storedVariables['autonomous_fouls_and_other'] = {
                        'autoFouls': 0,
                        'autoInterference': 0,
                        'autoNoAuto': false
                    }
                }

                if(id === "auto_fouls") {
                    storedVariables['autonomous_fouls_and_other'].autoFouls += 1;
                }
                else if(id === "auto_interference") {
                    storedVariables['autonomous_fouls_and_other'].autoInterference += 1;
                }
                else if(id === "auto_no_auto") {
                    storedVariables['autonomous_fouls_and_other'].autoNoAuto = true;
                }

                stageVariables = storedVariables['autonomous_fouls_and_other'];
            }


            // show alerts and bail if they exist
            if(errorMessage.length !== 0) {
                $("#alert-text").html(errorMessage.join('<br>'));
                $("#alert").show();
                return;
            }

            // otherwise hide any active alerts
            $("#alert").hide();

            // pull current things out of localStorage for our match ID
            var localStorageVariables = $.parseJSON(localStorage["match" + localStorage.pageMatchID]);

            // append our current values to the array that we get
            localStorageVariables[fromStage] = stageVariables;

            // push it back to localStorage
            localStorage['match' + localStorage.pageMatchID] = JSON.stringify(localStorageVariables);

            // hide our current stage
            $("#" + fromStage).hide();

            // change hash triggering the next stage to show
            window.location.hash = toStage;
        }

        window.onhashchange = function() {
            console.log('new hash: ' + window.location.hash);
            $(".stage").hide();

            openStage(window.location.hash.substring(1));
            $("#" + window.location.hash.substring(1)).show();
        }

        window.onload = function() {
            console.log('reloaded: ' + window.location.hash);
            $(".stage").hide();

            openStage(window.location.hash.substring(1));
            $("#" + window.location.hash.substring(1)).show();
        }

        function openStage(stage) {
            /**
             * TO STAGES
             **/

            var storedVariables = $.parseJSON(localStorage["match" + localStorage.pageMatchID]);

            try {
                $(".team-number").text(": " + storedVariables.prematch.teamNumber);
            } catch(e) {}

            if(localStorage.allianceColor === "blue_alliance") {
                $("body").css("background-color", backgroundColorBlue);
                $("#blue_alliance").addClass('active');
            }

            else if(localStorage.allianceColor === "red_alliance") {
                $("body").css("background-color", backgroundColorRed);
                $("#red_alliance").addClass('active');
            }

            if(stage === "prematch") {
                try {
                    $("#team_number").val(storedVariables.prematch.teamNumber);
                    $("#match_number").val(storedVariables.prematch.matchNumber);
                } catch(e) {}
            }

            else if(stage === "autonomous") {
                // totes
                try {
                    $("#auto-stacked-yellow-tote-text").text(storedVariables.autonomous.autoStackedYellowTotes);
                    $("#auto-moved-yellow-tote-text").text(storedVariables.autonomous.autoMovedYellowTotes);
                    $("#auto-acquired-grey-tote-text").text(storedVariables.autonomous.autoAcquiredGreyTotes);

                    // bins
                    $("#auto-acquired-step-bin-text").text(storedVariables.autonomous.autoAcquiredStepBins);
                    $("#auto-acquired-ground-bin-text").text(storedVariables.autonomous.autoAcquiredGroundBins);
                    $("#auto-moved-bin-text").text(storedVariables.autonomous.autoMovedBins);
                } catch(e) {}
            }
        }

        /*
         universal function that will add/subtract things from labels appended with -text from their respective buttons
         */
        $(".btn-add-subtract").click(function() {
            var sender = $(this);
            var name = sender.data('name');

            var target = $("#" + name + "-text");

            if(target.data('max')) {
                var max = parseInt(target.data('max'));
            }

            if(sender.data('operation') === "add") {
                if(typeof max !== 'undefined' && parseInt(target.text()) < max || typeof max === 'undefined') {
                    target.text(parseInt(target.text()) + 1);
                }
            }

            else if(sender.data('operation' == "subtract")) {
                if(parseInt(target.text()) > 0) {
                   target.text(parseInt(target.text()) - 1);
                }
            }
        })

    </script>
{% endblock %}