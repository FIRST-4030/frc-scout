{% extends 'frc_scout/base.html' %}

{% load staticfiles %}

{% block title %}Pit Scouting{% endblock %}

{% load compress %}

{% block extra_css %}
    {% compress css inline %}
        <style type="text/css">
            ::-webkit-input-placeholder { /* WebKit browsers */
                color:    #666666 !important;
            }
            :-moz-placeholder { /* Mozilla Firefox 4 to 18 */
                color:    #666666 !important;
                opacity:  1;
            }
            ::-moz-placeholder { /* Mozilla Firefox 19+ */
                color:    #666666 !important;
                opacity:  1;
            }
            :-ms-input-placeholder { /* Internet Explorer 10+ */
                color:    #666666 !important;
            }

            h2 {
                margin-bottom: -2px;
            }

            .set-indeterminate {
                margin-left: 10px;
                height: 36px;
            }
        </style>
    {% endcompress %}
    {% compress css %}
        <link rel="stylesheet" type="text/css" href="{% static 'frc_scout/css/bootstrap-switch.min.css' %}">
    {% endcompress %}
{% endblock %}

{% block nav %}{% include 'frc_scout/nav.html' %}{% endblock %}

{% block main_content %}
    <h6>The team number, and any other attribute, are the only required fields here &mdash; fill out what you know.</h6>
    <div class="alert alert-success" style="display: none;" id="success_message">
        <p><span class="glyphicon glyphicon-check"></span>&nbsp; Data submitted successfully, you may now enter more.</p>
    </div>
    <div class="alert alert-warning" style="display: none;" id="insufficient_message">
        <p><span class="glyphicon glyphicon-exclamation-sign"></span>&nbsp; You must enter some attribute <strong>other than team number</strong> &mdash; otherwise your data is useless!</p>
    </div>
    <div class="alert alert-warning" style="display: none;" id="required_message">
        <p><span class="glyphicon glyphicon-exclamation-sign"></span>&nbsp; <strong>Team number is required.</strong></p>
    </div>
    <form onclick="$('#success_message, #insufficient_message, #required_message').slideUp(200);" class="form-horizontal" id="pit_scout_form" onsubmit="submitForm(); return false;">
        <fieldset>
            <legend>Basic Information</legend>

            <div class="form-group">
                <label for="team_number" class="col-lg-2 control-label"><span style="color:firebrick">*</span> Team Number</label>
                <div class="col-lg-10">
                    <input type="number" class="form-control" id="team_number" placeholder="Team Number" required>
                </div>
            </div>
            <div class="form-group">
                <label for="team_number" class="col-lg-2 control-label">Robot Picture</label>
                <div class="col-lg-10">
                    <input type="file" accept="image/*" capture="camera" id="robot_image" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label for="team_name" class="col-lg-2 control-label">Team Name</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="team_name" placeholder="Team Name">
                </div>
            </div>
            <div class="form-group">
                <label for="team_name" class="col-lg-2 control-label">Team Website</label>
                <div class="col-lg-10">
                    <input type="url" class="form-control" id="team_website" placeholder="Team Website">
                </div>
            </div>
            <div class="form-group">
                <label for="coach" class="col-lg-2 control-label">Coach</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="coach" placeholder="Coach">
                </div>
            </div>
            <div class="form-group">
                <label for="driver_1" class="col-lg-2 control-label">Driver 1</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="driver_1" placeholder="Driver 1">
                </div>
            </div>
            <div class="form-group">
                <label for="driver_2" class="col-lg-2 control-label">Drive 2</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="driver_2" placeholder="Driver 2">
                </div>
            </div>

            <legend>Robot Specifications</legend>
            <div class="form-group">
                <label for="robot_height" class="col-lg-2 control-label">Height (inches)</label>
                <div class="col-lg-10">
                    <input type="number" class="form-control" id="robot_height" placeholder="Height">
                </div>
            </div>
            <div class="form-group">
                <label for="robot_weight" class="col-lg-2 control-label">Weight (lbs)</label>
                <div class="col-lg-10">
                    <input type="number" class="form-control" id="robot_weight" placeholder="Weight">
                </div>
            </div>

            <legend>Autonomous</legend>
            <div class="form-group">
                <label for="can_move_totes" class="col-lg-2 control-label">Can Move Totes</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="can_move_totes">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="can_move_containers" class="col-lg-2 control-label">Can Move Containers</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="can_move_containers">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="can_acquire_containers" class="col-lg-2 control-label">Can Acquire Containers</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="can_acquire_containers">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="preferred_auto_start" class="col-lg-2 control-label">Preferred Starting Location</label>
                <div class="col-lg-10">
                    <button type="button" class="btn btn-primary" id="toggle_modal" data-toggle="modal" data-target="#autoStartModal">Select</button>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="autoStartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="myModalLabel">Click Preferred Start Location</h4>
                        </div>
                        <div class="modal-body">
                            <img id="auto_start_image" src="{% static 'frc_scout/img/start_zone.png' %}" style="background-color: cyan; width: 100%;">
                        </div>
                    </div>
                </div>
            </div>


            <legend>Teleoperated</legend>
            <div class="form-group">
                <label for="tote_stack_capacity" class="col-lg-2 control-label">Tote Stack Capacity</label>
                <div class="col-lg-10">
                    <select class="form-control" id="tote_stack_capacity">
                        <option value="">Unknown</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </div>

            <legend>Human Interaction</legend>
            <div class="form-group">
                <label for="human_tote_loading" class="col-lg-2 control-label">Human Can Load Totes</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="human_tote_loading">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="human_litter_loading" class="col-lg-2 control-label">Human Can Load Litter</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="human_litter_loading">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="human_litter_throwing" class="col-lg-2 control-label">Human Can Throw Litter</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="human_litter_throwing">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>

            <legend>Maneuvering</legend>
            <div class="form-group">
                <label for="has_turret" class="col-lg-2 control-label">Has Turret</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="has_turret">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="has_strafing" class="col-lg-2 control-label">Has Strafing</label>
                <div class="col-lg-10">
                    <input type="checkbox" class="form-control" id="has_strafing">
                    <button type="button" class="btn btn-info set-indeterminate">Unknown</button>
                </div>
            </div>
            <div class="form-group">
                <label for="robot_speed" class="col-lg-2 control-label">Robot Speed (ft/s)</label>
                <div class="col-lg-10">
                    <input type="number" class="form-control" id="robot_speed" placeholder="Speed">
                </div>
            </div>


            <legend>Comments</legend>
            <div class="form-group">
                <label for="known_strengths" class="col-lg-2 control-label">Known Strengths</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="known_strengths" placeholder="Strengths">
                </div>
            </div>
            <div class="form-group">
                <label for="known_weaknesses" class="col-lg-2 control-label">Known Weaknesses</label>
                <div class="col-lg-10">
                    <input type="text" class="form-control" id="known_weaknesses" placeholder="Weaknesses">
                </div>
            </div>

            <br>
            <div class="form-group">
                <div class="col-sm-2 col-sm-offset-2">
                    <button id="submit_button" type="submit" class="btn btn-lg btn-primary">Submit</button>
                </div>
                <div class="col-sm-8">
                    <div class="progress" id="submit_progress" style="display: none; margin-top: 10px;">
                        <div class="progress-bar progress-bar-info" id="submit_progress_bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            <span class="sr-only">60% Complete</span>
                        </div>
                    </div>
                    <p style="display: none;" id="failure">Image upload failed.</p>
                </div>
            </div>

            <input type="hidden" id="auto_start_x">
            <input type="hidden" id="auto_start_y">
        </fieldset>
    </form>
{% endblock %}

{% block extra_js %}
    {% compress js %}
        <script type="text/javascript" src="{% static 'frc_scout/js/bootstrap-switch.min.js' %}"></script>
    {% endcompress %}
    {% compress js inline %}
        <script type="text/javascript">
            $("input[type=checkbox]").bootstrapSwitch({
                'offText': "NO",
                'onText': "YES",
                'size': 'large',
                'indeterminate': true
            });

            $(function() {
                if(window.location.hash) {
                    if(!isNaN(window.location.hash.substr(1))) {
                        $("#team_number").val(window.location.hash.substr(1));
                    }
                }
            });

            $(".set-indeterminate").click(function() {
                $(this).prev('.bootstrap-switch').find('input[type=checkbox]').bootstrapSwitch('indeterminate', true);
            });

            function getFormData() {
                var data = {}

                $.each($("#pit_scout_form").find('input, select').not('input[type=checkbox], input[type=file]'), function() {
                    if($(this).val() !== "") {
                        if(!isNaN($(this).val())) {
                            data[this.id] = parseFloat($(this).val());
                        } else {
                            data[this.id] = $(this).val();
                        }
                    }
                });

                $.each($("#pit_scout_form").find('input[type=checkbox]'), function() {
                    if(!$(this).bootstrapSwitch('indeterminate')) {
                        data[this.id] = $(this).bootstrapSwitch('state');
                    }
                })

                return data;
            }

            function clearForm() {
                $.each($("#pit_scout_form").find('input, select').not('input[type=checkbox]'), function() {
                    $(this).val("");
                });

                $.each($("#pit_scout_form").find('input[type=checkbox]'), function() {
                    $(this).bootstrapSwitch('indeterminate', true);
                })

                $("#toggle_modal")
                        .removeClass('success')
                        .addClass('primary')
                        .text("SELECT");

                $("#failure").hide();
            }

            /*
             Get the relative coordinates from start image
             */
            $("#auto_start_image").click(function (event) {
                var image = $(this);

                var xPosition = (event.pageX - image.offset().left) / image.width();
                var yPosition = (event.pageY - image.offset().top) / image.height();


                if((yPosition > 0.18 && yPosition < 0.4) || yPosition > 0.62) {
                    if(!confirm("Confirm autonomous starting location.")) {
                        return;
                    }

                    $("#auto_start_x").val(xPosition);
                    $("#auto_start_y").val(yPosition);
                    $("#autoStartModal").modal('hide');

                    $("#toggle_modal")
                            .removeClass('btn-primary')
                            .addClass('btn-success')
                            .html("<span class='glyphicon glyphicon-check'></span> Location set, click to edit.");
                } else {
                    alert("Invalid Location.");
                }
            });

            window.onbeforeunload = function() {
                if(Object.keys(getFormData()).length > 0) {
                    return "You've entered data into the form. Are you sure you want to reload the page?";
                }
            }

            function submitForm() {
                if($("#team_number").val() === "") {
                    window.scrollTo(0, 1);
                    $("#required_message").show();
                    return;
                }
                if(Object.keys(getFormData()).length > 1 || $("#robot_image").val() !== "") {

                    $("#submit_progress").show();
                    $("#submit_progress_bar").css('width', '20%');

                    $("#submit_button").button('loading');
                    postToImgur();
                } else {
                    window.scrollTo(0, 1);
                    $("#insufficient_message").show();
                }
            }

            function postToImgur() {
                var formData = new FormData();
                formData.append("image", $("#robot_image")[0].files[0]);
                $.ajax({
                    url: "https://api.imgur.com/3/image",
                    type: "POST",
                    datatype: "json",
                    headers: {
                        "Authorization": "Client-ID 74944771f93ba86"
                    },
                    data: formData,
                    success: function(response) {
                        console.log(response);
                        $("#submit_progress_bar").css('width', '80%');
                        postFormData(response);
                    },
                    error: function(response) {
                        $("#submit_progress_bar").css('width', '0%');
                        $("#failure").show();
                        postFormData(response);

                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }

            function postFormData(imageData) {
                var formData = getFormData();

                $.ajax({
                    url: '{% url "frc_scout:submit_pit_scouting_data" %}',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: $.cookie('csrftoken'),
                        data: JSON.stringify(formData),
                        image_data: JSON.stringify(imageData)
                    },
                    success: function() {
                        $("#submit_progress_bar").css('width', '100%');
                        window.setTimeout(function() {
                            $("#submit_button").button('reset');
                            clearForm();
                            window.scrollTo(0, 1);
                            $("#success_message").show();
                            $("#submit_progress").hide();
                        }, 2000);
                    }
                })

            }
        </script>
    {% endcompress %}
{% endblock %}

{% block footer %}{% include 'frc_scout/footer.html' %}{% endblock %}
